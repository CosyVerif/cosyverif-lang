box: cosyverif/environment:master
build:
  steps:
    - script:
        name: "Build server"
        code: |
          ./bin/build-server --in-ci --prefix=/app
    - script:
        name: "Build client"
        code: |
          ./bin/build-client --in-ci --prefix=/app
    - script:
        name: "Fix permissions"
        code: |
          chown -R root.users /app
    - script:
        name: "Check server"
        code: |
          export CPATH="/app/include:${CPATH}"
          export LIBRARY_PATH="/app/lib:${LIBRARY_PATH}"
          export LD_LIBRARY_PATH="/app/lib:${LD_LIBRARY_PATH}"
          /app/bin/cosy-check --output=. --test-format=junit
    - script:
        name: "Check client"
        code: |
          export CPATH="/app/include:${CPATH}"
          export LIBRARY_PATH="/app/lib:${LIBRARY_PATH}"
          export LD_LIBRARY_PATH="/app/lib:${LD_LIBRARY_PATH}"
          /app/bin/cosy-server start --port=8080 --clean
          ./cosy-client-*.sh --target client
          ./tests/user.sh default ./client/bin/cosy --server=http://127.0.0.1:8080/
          /app/bin/cosy-server stop

deploy:
  steps:
    - add-to-known_hosts:
      hostname: public.cosyverif.lsv.fr
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: Write key
        filename: $PRIVATEKEY_PATH
        content: $KEYPAIR_PRIVATE
        overwrite: true
        hide-from-log: true
    - script:
        name: Stop
        code: ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "./install/$WERCKER_GIT_BRANCH/bin/cosy-server stop --alias="$WERCKER_GIT_BRANCH" || true"
    - script:
        name: Build
        code: |
          ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "rm -rf sources-$WERCKER_GIT_BRANCH"
          ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "git clone https://github.com/$WERCKER_GIT_OWNER/$WERCKER_GIT_REPOSITORY sources-$WERCKER_GIT_BRANCH"
          ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "cd sources-$WERCKER_GIT_BRANCH && git checkout $WERCKER_GIT_BRANCH"
          ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "cd sources-$WERCKER_GIT_BRANCH && ./bin/build-server --prefix=/home/cosy/install/$WERCKER_GIT_BRANCH"
    - script:
        name: Copy database
        code: |
          if [ "$WERCKER_GIT_BRANCH" != "master" ]; then
            ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "mkdir -p /home/cosy/.cosy/$WERCKER_GIT_BRANCH"
            ssh -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "cp /home/cosy/.cosy/master/redis.db /home/cosy/.cosy/$WERCKER_GIT_BRANCH/redis.db"
          fi
    - script:
        name: Start
        code: |
          if ["WERCKER_GIT_BRANCH" = "master" ]; then
            PORT=8080
          else
            PORT=8181
          fi
          ssh -f -i $PRIVATEKEY_PATH -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no cosy@public.cosyverif.lsv.fr "./install/$WERCKER_GIT_BRANCH/bin/cosy-server start --alias="$WERCKER_GIT_BRANCH" --port=$PORT"
