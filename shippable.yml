build_image: shippableimages/ubuntu1404_python

before_script:
  - rm    -rf output
  - mkdir -p  output

install:
  - sudo apt-get install redis-server
  - ./bin/build-server --prefix=$HOME/cosy
  - $HOME/cosy/bin/lua -e "print (package.path); print (package.cpath)"
  - ls $HOME/cosy/lib/lua/5.2
  - $HOME/cosy/bin/lua -e "require 'bcrypt'"

before_script:
  - redis-server &
  - sleep 1

script:
  - ${HOME}/cosy/bin/cosy-check  output --test-format=junit
  - ${HOME}/cosy/bin/cosy-server start --clean
  - ./tests/user.sh ${HOME}/cosy/bin/cosy http://127.0.0.1:8080/
  - ${HOME}/cosy/server/bin/cosy-server stop

after_script:
  - for file in output/test/*; do mv ${file} shippable/testresults/$(basename ${file}).xml; done

notifications:
  email:
    recipients:
      - alban@linard.fr
      - leprieur@lipn.univ-paris13.fr
    on_success: change
    on_failure: always
