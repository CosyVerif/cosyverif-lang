build_image: shippableimages/ubuntu1404_python

install:
  - ./bin/build-server --in-ci --prefix=$HOME/cosy
  - ./bin/build-client --in-ci

before_script:
  - rm -rf output && mkdir -p output
  - redis-server & sleep 1

script:
  - ${HOME}/cosy/bin/cosy-check --output=output --test-format=junit

after_failure:
  - ${HOME}/cosy/bin/cosy-server start --force --clean --port=8090
  - curl -v http://127.0.0.1:8090/lua/dkjson
  - curl -v http://localhost:8090/lua/dkjson
  - ${HOME}/cosy/bin/cosy-server stop --force
  - cat ${HOME}/.cosy/__busted__/nginx.conf
  - cat ${HOME}/.cosy/__busted__/nginx/access.log
  - cat ${HOME}/.cosy/__busted__/nginx/error.log
  - cat ${HOME}/.cosy/__scenario__/nginx.conf
  - cat ${HOME}/.cosy/__scenario__/nginx/access.log
  - cat ${HOME}/.cosy/__scenario__/nginx/error.log

after_success:
  - ls output/
  - for file in output/test/*; do mv ${file} shippable/testresults/$(basename ${file}).xml; done

notifications:
  email:
    recipients:
      - alban@linard.fr
      - leprieur@lipn.univ-paris13.fr
    on_success: change
    on_failure: change
