language: php
php:
  - 5.3

services:
 - redis

install:
  - sudo apt-get autoremove -y
  - sudo apt-get install tree
  - ./bin/build-client --in-ci
  - ./bin/build-server --prefix=$HOME/cosy/server --in-ci

before_script:
  - ${HOME}/cosy/server/local/cosy/5.1/bin/luarocks list
  - ${HOME}/cosy/server/local/cosy/5.2/bin/luarocks list
  - rm    -rf shippable/testresults
  - mkdir -p  shippable/testresults
  - rm    -rf output
  - mkdir -p  output/server

script:
  - source ${HOME}/cosy/server/bin/cosy-path && echo $LUA_PATH && echo $LUA_CPATH && tree ${HOME}/cosy/
  - ${HOME}/cosy/server/bin/cosy-check output/server --test-format=junit

after_script:
  - for file in output/server/test/*; do mv ${file} shippable/testresults/$(basename ${file}).xml; done

notifications:
  email:
    recipients:
      - alban@linard.fr
      - leprieur@lipn.univ-paris13.fr
    on_success: change
    on_failure: always
